[
    {
        "id": "24208985562",
        "type": "IssueCommentEvent",
        "actor": {
            "id": 7192832,
            "login": "pocketjoso",
            "display_login": "pocketjoso",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pocketjoso",
            "avatar_url": "https://avatars.githubusercontent.com/u/7192832?"
        },
        "repo": {
            "id": 20474738,
            "name": "pocketjoso/penthouse",
            "url": "https://api.github.com/repos/pocketjoso/penthouse"
        },
        "payload": {
            "action": "created",
            "issue": {
                "url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348",
                "repository_url": "https://api.github.com/repos/pocketjoso/penthouse",
                "labels_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/labels{/name}",
                "comments_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/comments",
                "events_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/events",
                "html_url": "https://github.com/pocketjoso/penthouse/issues/348",
                "id": 1375841548,
                "node_id": "I_kwDOAThrcs5SAa0M",
                "number": 348,
                "title": "bug(iframes): timed out if lazy loaded iframes",
                "user": {
                    "login": "Kristinita",
                    "id": 17247677,
                    "node_id": "MDQ6VXNlcjE3MjQ3Njc3",
                    "avatar_url": "https://avatars.githubusercontent.com/u/17247677?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/Kristinita",
                    "html_url": "https://github.com/Kristinita",
                    "followers_url": "https://api.github.com/users/Kristinita/followers",
                    "following_url": "https://api.github.com/users/Kristinita/following{/other_user}",
                    "gists_url": "https://api.github.com/users/Kristinita/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/Kristinita/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/Kristinita/subscriptions",
                    "organizations_url": "https://api.github.com/users/Kristinita/orgs",
                    "repos_url": "https://api.github.com/users/Kristinita/repos",
                    "events_url": "https://api.github.com/users/Kristinita/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/Kristinita/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "labels": [],
                "state": "open",
                "locked": false,
                "assignee": null,
                "assignees": [],
                "milestone": null,
                "comments": 0,
                "created_at": "2022-09-16T11:52:34Z",
                "updated_at": "2022-09-25T16:29:20Z",
                "closed_at": null,
                "author_association": "NONE",
                "active_lock_reason": null,
                "body": "**#257** \u2014 possibly related issue\n\n### 1. Summary\n\nIf I use [**native lazy loading for iframes**](https://addyosmani.com/blog/native-iframe-lazy-loading/) in my HTML files, Penthouse doesn\u2019t create critical CSS for these files. I get a stack trace:\n\n```js\n/home/travis/build/Kristinita/SashaTravis/node_modules/penthouse/lib/core.js:342\n\n\t\terror: new Error('Penthouse timed out after ' + timeout / 1000 + 's. ')\n\n\t\t\t   ^\n\nError: Penthouse timed out after 30s.\n\n\tat Timeout.<anonymous> (/home/travis/build/Kristinita/SashaTravis/node_modules/penthouse/lib/core.js:342:16)\n\n\tat listOnTimeout (node:internal/timers:564:17)\n\n\tat process.processTimers (node:internal/timers:507:7)\n```\n\n### 2. MCVE\n\n[**This configuration on GitHub**](https://github.com/Kristinita/SashaTravis/tree/KiraPenthouseIframes), [**Travis CI build for it**](https://app.travis-ci.com/github/Kristinita/SashaTravis/jobs/583027378).\n\n1. `package.json`:\n\n\t```json\n\t{\n\t\t\"dependencies\": {\n\t\t\t\"penthouse\": \"^2.3.3\"\n\t\t}\n\t}\n\n\t```\n\n1. `KiraExamplePassed.html`:\n\n\t```html\n\t<!DOCTYPE html>\n\t<html lang=\"ru\">\n\t\t<head>\n\t\t\t<meta charset=\"utf-8\">\n\t\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t\t\t<title>Penthouse + lazy-loaded iframes MCVE \u2014 passed</title>\n\t\t\t<!-- [INFO] In real files I have HTML markup before the iframe instead of \u201cmargin-bottom\u201d -->\n\t\t\t<style>\n\t\t\t\t.KiraExampleClass { margin-bottom: 1rem; }\n\t\t\t</style>\n\t\t\t<!-- [INFO] Iframes native lazy loading polyfill:\n\t\t\thttps://github.com/mfranzke/loading-attribute-polyfill -->\n\t\t\t<script src=\"https://cdn.jsdelivr.net/npm/loading-attribute-polyfill/dist/loading-attribute-polyfill.umd.min.js\" async></script>\n\t\t</head>\n\t\t<body>\n\t\t\t<div class=\"KiraExampleClass\"></div>\n\t\t\t<!-- [INFO] Iframes syntax:\n\t\t\thttps://github.com/mfranzke/loading-attribute-polyfill#iframe -->\n\t\t\t<noscript class=\"loading-lazy\">\n\t\t\t\t<iframe title=\"KiraExamplePeerTubeVideo\" width=\"560\" height=\"315\" src=\"https://video.ploud.fr/videos/embed/15613130-601b-4101-bc39-2dde03256254\" loading=\"lazy\"></iframe>\n\t\t\t</noscript>\n\t\t</body>\n\t</html>\n\n\t```\n\n1. `KiraExampleFailed.html`:\n\n\t```html\n\t<!DOCTYPE html>\n\t<html lang=\"ru\">\n\t\t<head>\n\t\t\t<meta charset=\"utf-8\">\n\t\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t\t\t<title>Penthouse + lazy-loaded iframes MCVE \u2014 passed</title>\n\t\t\t<!-- [INFO] In real files I have HTML markup before the iframe instead of \u201cmargin-bottom\u201d -->\n\t\t\t<style>\n\t\t\t\t\t.KiraExampleClass { margin-bottom: 500rem; }\n\t\t\t</style>\n\t\t\t<!-- [INFO] Iframes native lazy loading polyfill:\n\t\t\thttps://github.com/mfranzke/loading-attribute-polyfill -->\n\t\t\t<script src=\"https://cdn.jsdelivr.net/npm/loading-attribute-polyfill/dist/loading-attribute-polyfill.umd.min.js\" async></script>\n\t\t</head>\n\t\t<body>\n\t\t\t<div class=\"KiraExampleClass\"></div>\n\t\t\t<!-- [INFO] Iframes syntax:\n\t\t\thttps://github.com/mfranzke/loading-attribute-polyfill#iframe -->\n\t\t\t<noscript class=\"loading-lazy\">\n\t\t\t\t<iframe title=\"KiraExamplePeerTubeVideo\" width=\"560\" height=\"315\" src=\"https://video.ploud.fr/videos/embed/15613130-601b-4101-bc39-2dde03256254\" loading=\"lazy\"></iframe>\n\t\t\t</noscript>\n\t\t</body>\n\t</html>\n\n\t```\n\n\t```diff\n\t-\t.KiraExampleClass { margin-bottom: 1rem; }\n\t+\t.KiraExampleClass { margin-bottom: 500rem; }\n\t```\n\n\n1. `KiraPenthousePassed.js`:\n\n\t```js\n\tconst penthouse = require('penthouse');\n\tconst fs = require('fs');\n\n\tpenthouse({\n\t\t// [INFO] \u201curl: 'file:///D:/SashaDemoRepositories/SashaTravis/KiraExamplePassed.html',\u201d for my Windows\n\t\turl: 'file:///home/travis/build/Kristinita/SashaTravis/KiraExamplePassed.html',\n\t\tcssString: 'body { color: red }'\n\t})\n\t\t.then(criticalCss => {\n\t\t\tfs.writeFileSync('KiraOutfilePassed.css', criticalCss);\n\t\t});\n\n\t```\n\n1. `KiraPenthouseFailed.js`:\n\n\t```js\n\tconst penthouse = require('penthouse');\n\tconst fs = require('fs');\n\n\tpenthouse({\n\t\t// [INFO] \u201curl: 'file:///D:/SashaDemoRepositories/SashaTravis/KiraExampleFailed.html',\u201d for my Windows\n\t\turl: 'file:///home/travis/build/Kristinita/SashaTravis/KiraExampleFailed.html',\n\t\tcssString: 'body { color: red }'\n\t})\n\t\t.then(criticalCss => {\n\t\t\tfs.writeFileSync('KiraOutfileFailed.css', criticalCss);\n\t\t});\n\n\t```\n\n\t```diff\n\t-\t// [INFO] \u201curl: 'file:///D:/SashaDemoRepositories/SashaTravis/KiraExamplePassed.html',\u201d for my Windows\n\t-\turl: 'file:///home/travis/build/Kristinita/SashaTravis/KiraExamplePassed.html',\n\t+\t// [INFO] \u201curl: 'file:///D:/SashaDemoRepositories/SashaTravis/KiraExampleFailed.html',\u201d for my Windows\n\t+\turl: 'file:///home/travis/build/Kristinita/SashaTravis/KiraExampleFailed.html',\n\n\t-\tfs.writeFileSync('KiraOutfilePassed.css', criticalCss);\n\t+\tfs.writeFileSync('KiraOutfileFailed.css', criticalCss);\n\t```\n\n1. The part of the `.travis.yml`:\n\n\t```yaml\n\tinstall:\n\t- npm install\n\n\tscript:\n\t- env DEBUG=\"penthouse,penthouse:*\" node KiraPenthousePassed.js\n\t- env DEBUG=\"penthouse,penthouse:*\" node KiraPenthouseFailed.js\n\n\t```\n\n### 3. Behavior\n\n#### 3.1. Desired \u2014 KiraPenthousePassed.js\n\n[**Travis link**](https://app.travis-ci.com/github/Kristinita/SashaTravis/jobs/583027378#L196):\n\n```js\n$ env DEBUG=\"penthouse,penthouse:*\" node KiraPenthousePassed.js\n\n  penthouse:browser no browser instance, launching new browser.. +0ms\n\n  penthouse:browser browser ready +250ms\n\n  penthouse call generateCriticalCssWrapped +0ms\n\n  penthouse:core Penthouse core start +0ms\n\n  penthouse:core parse ast START +0ms\n\n  penthouse:core parse ast DONE (with 0 errors) +3ms\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover BEFORE +0ms\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover matchConfig: {\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"type\": \"screen\",\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"width\": \"1300px\",\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"height\": \"900px\"\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover }\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover keepLargerMediaQueries: false +0ms\n\n  penthouse:core stripped out non matching media queries +1ms\n\n  penthouse:browser re-using the page browser launched with +95ms\n\n  penthouse:browser re-using browser page for generateCriticalCss, remaining at: 1 +0ms\n\n  penthouse:core open page ready in browser +88ms\n\n  penthouse:core page event listeners set +1ms\n\n  penthouse:core userAgent set +1ms\n\n  penthouse:core blocking js requests DONE +1ms\n\n  penthouse:core preparePage DONE +0ms\n\n  penthouse:core page load start +0ms\n\n  penthouse:core turn css to formatted selectorlist START +1ms\n\n  penthouse:preformatting:selectors-profile buildSelectorProfile START +0ms\n\n  penthouse:preformatting:selectors-profile forceInclude body +1ms\n\n  penthouse:preformatting:selectors-profile buildSelectorProfile DONE +0ms\n\n  penthouse:core turn css to formatted selectorlist DONE +1ms\n\n  penthouse:core page load DONE +2s\n\n  penthouse:core waited for renderWaitTime: 100 +100ms\n\n  penthouse:core pruneNonCriticalSelectors init +4ms\n\n  penthouse:core filterSelectors START +0ms\n\n  penthouse:core filterSelectors DONE +0ms\n\n  penthouse:core pruneNonCriticalSelectors done +1ms\n\n  penthouse:core AST cleanup START +0ms\n\n  penthouse:css-cleanup start +0ms\n\n  penthouse:css-cleanup commentRemover +0ms\n\n  penthouse:css-cleanup ruleSelectorRemover +0ms\n\n  penthouse:css-cleanup:unused-keyframe-remover getAllAnimationKeyframes +0ms\n\n  penthouse:css-cleanup:unused-keyframe-remover getAllAnimationKeyframes AFTER, usedKeyFrames: 0 +3ms\n\n  penthouse:css-cleanup unusedKeyframeRemover +3ms\n\n  penthouse:css-cleanup:embeddedbase64Remover config: maxEmbeddedBase64Length = 1000 +0ms\n\n  penthouse:css-cleanup embeddedbase64Remover +1ms\n\n  penthouse:css-cleanup:unused-font-face-remover getAllFontNameValues +0ms\n\n  penthouse:css-cleanup:unused-font-face-remover getAllFontNameValues AFTER +0ms\n\n  penthouse:css-cleanup unusedFontFaceRemover +0ms\n\n  penthouse:css-cleanup propertiesToRemove +0ms\n\n  penthouse:css-cleanup finalRuleRemover +1ms\n\n  penthouse:core AST cleanup DONE +5ms\n\n  penthouse:core generated CSS from AST +0ms\n\n  penthouse:core generateCriticalCss DONE +0ms\n\n  penthouse:core cleanupAndExit +0ms\n\n  penthouse:browser remove (maybe) browser page for generateCriticalCss, before removing was: 1 +2s\n\n  penthouse:browser now try to close browser page +0ms\n\n  penthouse generateCriticalCss done +2s\n\n  penthouse:browser closed browser +18ms\n\nThe command \"env DEBUG=\"penthouse,penthouse:*\" node KiraPenthousePassed.js\" exited with 0.\n```\n\n**If** my iframe at the top of my real HTML page and loads when the page is opened, I don\u2019t get errors when using Penthouse.\n\n#### 3.2. Error \u2014 KiraPenthouseFailed.js\n\n[**Travis link**](https://app.travis-ci.com/github/Kristinita/SashaTravis/jobs/583027378#L253):\n\n```js\n$ env DEBUG=\"penthouse,penthouse:*\" node KiraPenthouseFailed.js\n\n  penthouse:browser no browser instance, launching new browser.. +0ms\n\n  penthouse:browser browser ready +103ms\n\n  penthouse call generateCriticalCssWrapped +0ms\n\n  penthouse:core Penthouse core start +0ms\n\n  penthouse:core parse ast START +1ms\n\n  penthouse:core parse ast DONE (with 0 errors) +2ms\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover BEFORE +0ms\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover matchConfig: {\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"type\": \"screen\",\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"width\": \"1300px\",\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"height\": \"900px\"\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover }\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover keepLargerMediaQueries: false +0ms\n\n  penthouse:core stripped out non matching media queries +3ms\n\n  penthouse:browser re-using the page browser launched with +91ms\n\n  penthouse:browser re-using browser page for generateCriticalCss, remaining at: 1 +1ms\n\n  penthouse:core open page ready in browser +79ms\n\n  penthouse:core page event listeners set +1ms\n\n  penthouse:core userAgent set +2ms\n\n  penthouse:core blocking js requests DONE +0ms\n\n  penthouse:core preparePage DONE +0ms\n\n  penthouse:core page load start +0ms\n\n  penthouse:core turn css to formatted selectorlist START +1ms\n\n  penthouse:preformatting:selectors-profile buildSelectorProfile START +0ms\n\n  penthouse:preformatting:selectors-profile forceInclude body +0ms\n\n  penthouse:preformatting:selectors-profile buildSelectorProfile DONE +0ms\n\n  penthouse:core turn css to formatted selectorlist DONE +1ms\n\n  penthouse:core cleanupAndExit +30s\n\n  penthouse:browser remove (maybe) browser page for generateCriticalCss, before removing was: 1 +30s\n\n  penthouse:browser now try to close browser page +0ms\n\n  penthouse:browser closed browser +18ms\n\n/home/travis/build/Kristinita/SashaTravis/node_modules/penthouse/lib/core.js:342\n\n\t\terror: new Error('Penthouse timed out after ' + timeout / 1000 + 's. ')\n\n\t\t\t   ^\n\nError: Penthouse timed out after 30s.\n\n\tat Timeout.<anonymous> (/home/travis/build/Kristinita/SashaTravis/node_modules/penthouse/lib/core.js:342:16)\n\n\tat listOnTimeout (node:internal/timers:564:17)\n\n\tat process.processTimers (node:internal/timers:507:7)\n\nNode.js v18.9.0\n\nThe command \"env DEBUG=\"penthouse,penthouse:*\" node KiraPenthouseFailed.js\" exited with 1.\n```\n\n**Else** my iframe is in the middle or end of my real HTML page and loads lazy, I get this stack trace when I use Penthouse.\n\n### 4. Environment\n\n1. Operating system:\n\n\t1. Local \u2014 Microsoft Windows [Version 10.0.19041.1415]\n\t1. Travis CI \u2014 Ubuntu 22.04 LTS Jammy Jellyfish\n\n1. Node.js v18.9.0\n1. Penthouse 2.3.3\n\nThanks.",
                "reactions": {
                    "url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "timeline_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/timeline",
                "performed_via_github_app": null,
                "state_reason": null
            },
            "comment": {
                "url": "https://api.github.com/repos/pocketjoso/penthouse/issues/comments/1257229353",
                "html_url": "https://github.com/pocketjoso/penthouse/issues/348#issuecomment-1257229353",
                "issue_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348",
                "id": 1257229353,
                "node_id": "IC_kwDOAThrcs5K78wp",
                "user": {
                    "login": "pocketjoso",
                    "id": 7192832,
                    "node_id": "MDQ6VXNlcjcxOTI4MzI=",
                    "avatar_url": "https://avatars.githubusercontent.com/u/7192832?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/pocketjoso",
                    "html_url": "https://github.com/pocketjoso",
                    "followers_url": "https://api.github.com/users/pocketjoso/followers",
                    "following_url": "https://api.github.com/users/pocketjoso/following{/other_user}",
                    "gists_url": "https://api.github.com/users/pocketjoso/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/pocketjoso/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/pocketjoso/subscriptions",
                    "organizations_url": "https://api.github.com/users/pocketjoso/orgs",
                    "repos_url": "https://api.github.com/users/pocketjoso/repos",
                    "events_url": "https://api.github.com/users/pocketjoso/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/pocketjoso/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "created_at": "2022-09-25T16:29:20Z",
                "updated_at": "2022-09-25T16:29:20Z",
                "author_association": "OWNER",
                "body": "Thanks a lot for the detail bug report, and the reproducible test case - I can reproduce the problem.\r\n\r\nI will do my best to find time to look into this, but I wouldn't count on myself finding a fix in the near term. My first hunch is that - as you linked to issue #257 - that this is a problem from puppeteer, the version that is currently used. So what I would do next is to try to upgrade the puppeteer version, and see if that fixes the problem.\r\n",
                "reactions": {
                    "url": "https://api.github.com/repos/pocketjoso/penthouse/issues/comments/1257229353/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "performed_via_github_app": null
            }
        },
        "public": true,
        "created_at": "2022-09-25T16:29:20Z"
    },
    {
        "id": "24208985562",
        "type": "IssueCommentEvent",
        "actor": {
            "id": 7192832,
            "login": "pocketjoso",
            "display_login": "pocketjoso",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pocketjoso",
            "avatar_url": "https://avatars.githubusercontent.com/u/7192832?"
        },
        "repo": {
            "id": 20474738,
            "name": "pocketjoso/penthouse",
            "url": "https://api.github.com/repos/pocketjoso/penthouse"
        },
        "payload": {
            "action": "created",
            "issue": {
                "url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348",
                "repository_url": "https://api.github.com/repos/pocketjoso/penthouse",
                "labels_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/labels{/name}",
                "comments_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/comments",
                "events_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/events",
                "html_url": "https://github.com/pocketjoso/penthouse/issues/348",
                "id": 1375841548,
                "node_id": "I_kwDOAThrcs5SAa0M",
                "number": 348,
                "title": "bug(iframes): timed out if lazy loaded iframes",
                "user": {
                    "login": "Kristinita",
                    "id": 17247677,
                    "node_id": "MDQ6VXNlcjE3MjQ3Njc3",
                    "avatar_url": "https://avatars.githubusercontent.com/u/17247677?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/Kristinita",
                    "html_url": "https://github.com/Kristinita",
                    "followers_url": "https://api.github.com/users/Kristinita/followers",
                    "following_url": "https://api.github.com/users/Kristinita/following{/other_user}",
                    "gists_url": "https://api.github.com/users/Kristinita/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/Kristinita/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/Kristinita/subscriptions",
                    "organizations_url": "https://api.github.com/users/Kristinita/orgs",
                    "repos_url": "https://api.github.com/users/Kristinita/repos",
                    "events_url": "https://api.github.com/users/Kristinita/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/Kristinita/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "labels": [],
                "state": "open",
                "locked": false,
                "assignee": null,
                "assignees": [],
                "milestone": null,
                "comments": 0,
                "created_at": "2022-09-16T11:52:34Z",
                "updated_at": "2022-09-25T16:29:20Z",
                "closed_at": null,
                "author_association": "NONE",
                "active_lock_reason": null,
                "body": "**#257** \u2014 possibly related issue\n\n### 1. Summary\n\nIf I use [**native lazy loading for iframes**](https://addyosmani.com/blog/native-iframe-lazy-loading/) in my HTML files, Penthouse doesn\u2019t create critical CSS for these files. I get a stack trace:\n\n```js\n/home/travis/build/Kristinita/SashaTravis/node_modules/penthouse/lib/core.js:342\n\n\t\terror: new Error('Penthouse timed out after ' + timeout / 1000 + 's. ')\n\n\t\t\t   ^\n\nError: Penthouse timed out after 30s.\n\n\tat Timeout.<anonymous> (/home/travis/build/Kristinita/SashaTravis/node_modules/penthouse/lib/core.js:342:16)\n\n\tat listOnTimeout (node:internal/timers:564:17)\n\n\tat process.processTimers (node:internal/timers:507:7)\n```\n\n### 2. MCVE\n\n[**This configuration on GitHub**](https://github.com/Kristinita/SashaTravis/tree/KiraPenthouseIframes), [**Travis CI build for it**](https://app.travis-ci.com/github/Kristinita/SashaTravis/jobs/583027378).\n\n1. `package.json`:\n\n\t```json\n\t{\n\t\t\"dependencies\": {\n\t\t\t\"penthouse\": \"^2.3.3\"\n\t\t}\n\t}\n\n\t```\n\n1. `KiraExamplePassed.html`:\n\n\t```html\n\t<!DOCTYPE html>\n\t<html lang=\"ru\">\n\t\t<head>\n\t\t\t<meta charset=\"utf-8\">\n\t\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t\t\t<title>Penthouse + lazy-loaded iframes MCVE \u2014 passed</title>\n\t\t\t<!-- [INFO] In real files I have HTML markup before the iframe instead of \u201cmargin-bottom\u201d -->\n\t\t\t<style>\n\t\t\t\t.KiraExampleClass { margin-bottom: 1rem; }\n\t\t\t</style>\n\t\t\t<!-- [INFO] Iframes native lazy loading polyfill:\n\t\t\thttps://github.com/mfranzke/loading-attribute-polyfill -->\n\t\t\t<script src=\"https://cdn.jsdelivr.net/npm/loading-attribute-polyfill/dist/loading-attribute-polyfill.umd.min.js\" async></script>\n\t\t</head>\n\t\t<body>\n\t\t\t<div class=\"KiraExampleClass\"></div>\n\t\t\t<!-- [INFO] Iframes syntax:\n\t\t\thttps://github.com/mfranzke/loading-attribute-polyfill#iframe -->\n\t\t\t<noscript class=\"loading-lazy\">\n\t\t\t\t<iframe title=\"KiraExamplePeerTubeVideo\" width=\"560\" height=\"315\" src=\"https://video.ploud.fr/videos/embed/15613130-601b-4101-bc39-2dde03256254\" loading=\"lazy\"></iframe>\n\t\t\t</noscript>\n\t\t</body>\n\t</html>\n\n\t```\n\n1. `KiraExampleFailed.html`:\n\n\t```html\n\t<!DOCTYPE html>\n\t<html lang=\"ru\">\n\t\t<head>\n\t\t\t<meta charset=\"utf-8\">\n\t\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t\t\t<title>Penthouse + lazy-loaded iframes MCVE \u2014 passed</title>\n\t\t\t<!-- [INFO] In real files I have HTML markup before the iframe instead of \u201cmargin-bottom\u201d -->\n\t\t\t<style>\n\t\t\t\t\t.KiraExampleClass { margin-bottom: 500rem; }\n\t\t\t</style>\n\t\t\t<!-- [INFO] Iframes native lazy loading polyfill:\n\t\t\thttps://github.com/mfranzke/loading-attribute-polyfill -->\n\t\t\t<script src=\"https://cdn.jsdelivr.net/npm/loading-attribute-polyfill/dist/loading-attribute-polyfill.umd.min.js\" async></script>\n\t\t</head>\n\t\t<body>\n\t\t\t<div class=\"KiraExampleClass\"></div>\n\t\t\t<!-- [INFO] Iframes syntax:\n\t\t\thttps://github.com/mfranzke/loading-attribute-polyfill#iframe -->\n\t\t\t<noscript class=\"loading-lazy\">\n\t\t\t\t<iframe title=\"KiraExamplePeerTubeVideo\" width=\"560\" height=\"315\" src=\"https://video.ploud.fr/videos/embed/15613130-601b-4101-bc39-2dde03256254\" loading=\"lazy\"></iframe>\n\t\t\t</noscript>\n\t\t</body>\n\t</html>\n\n\t```\n\n\t```diff\n\t-\t.KiraExampleClass { margin-bottom: 1rem; }\n\t+\t.KiraExampleClass { margin-bottom: 500rem; }\n\t```\n\n\n1. `KiraPenthousePassed.js`:\n\n\t```js\n\tconst penthouse = require('penthouse');\n\tconst fs = require('fs');\n\n\tpenthouse({\n\t\t// [INFO] \u201curl: 'file:///D:/SashaDemoRepositories/SashaTravis/KiraExamplePassed.html',\u201d for my Windows\n\t\turl: 'file:///home/travis/build/Kristinita/SashaTravis/KiraExamplePassed.html',\n\t\tcssString: 'body { color: red }'\n\t})\n\t\t.then(criticalCss => {\n\t\t\tfs.writeFileSync('KiraOutfilePassed.css', criticalCss);\n\t\t});\n\n\t```\n\n1. `KiraPenthouseFailed.js`:\n\n\t```js\n\tconst penthouse = require('penthouse');\n\tconst fs = require('fs');\n\n\tpenthouse({\n\t\t// [INFO] \u201curl: 'file:///D:/SashaDemoRepositories/SashaTravis/KiraExampleFailed.html',\u201d for my Windows\n\t\turl: 'file:///home/travis/build/Kristinita/SashaTravis/KiraExampleFailed.html',\n\t\tcssString: 'body { color: red }'\n\t})\n\t\t.then(criticalCss => {\n\t\t\tfs.writeFileSync('KiraOutfileFailed.css', criticalCss);\n\t\t});\n\n\t```\n\n\t```diff\n\t-\t// [INFO] \u201curl: 'file:///D:/SashaDemoRepositories/SashaTravis/KiraExamplePassed.html',\u201d for my Windows\n\t-\turl: 'file:///home/travis/build/Kristinita/SashaTravis/KiraExamplePassed.html',\n\t+\t// [INFO] \u201curl: 'file:///D:/SashaDemoRepositories/SashaTravis/KiraExampleFailed.html',\u201d for my Windows\n\t+\turl: 'file:///home/travis/build/Kristinita/SashaTravis/KiraExampleFailed.html',\n\n\t-\tfs.writeFileSync('KiraOutfilePassed.css', criticalCss);\n\t+\tfs.writeFileSync('KiraOutfileFailed.css', criticalCss);\n\t```\n\n1. The part of the `.travis.yml`:\n\n\t```yaml\n\tinstall:\n\t- npm install\n\n\tscript:\n\t- env DEBUG=\"penthouse,penthouse:*\" node KiraPenthousePassed.js\n\t- env DEBUG=\"penthouse,penthouse:*\" node KiraPenthouseFailed.js\n\n\t```\n\n### 3. Behavior\n\n#### 3.1. Desired \u2014 KiraPenthousePassed.js\n\n[**Travis link**](https://app.travis-ci.com/github/Kristinita/SashaTravis/jobs/583027378#L196):\n\n```js\n$ env DEBUG=\"penthouse,penthouse:*\" node KiraPenthousePassed.js\n\n  penthouse:browser no browser instance, launching new browser.. +0ms\n\n  penthouse:browser browser ready +250ms\n\n  penthouse call generateCriticalCssWrapped +0ms\n\n  penthouse:core Penthouse core start +0ms\n\n  penthouse:core parse ast START +0ms\n\n  penthouse:core parse ast DONE (with 0 errors) +3ms\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover BEFORE +0ms\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover matchConfig: {\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"type\": \"screen\",\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"width\": \"1300px\",\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"height\": \"900px\"\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover }\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover keepLargerMediaQueries: false +0ms\n\n  penthouse:core stripped out non matching media queries +1ms\n\n  penthouse:browser re-using the page browser launched with +95ms\n\n  penthouse:browser re-using browser page for generateCriticalCss, remaining at: 1 +0ms\n\n  penthouse:core open page ready in browser +88ms\n\n  penthouse:core page event listeners set +1ms\n\n  penthouse:core userAgent set +1ms\n\n  penthouse:core blocking js requests DONE +1ms\n\n  penthouse:core preparePage DONE +0ms\n\n  penthouse:core page load start +0ms\n\n  penthouse:core turn css to formatted selectorlist START +1ms\n\n  penthouse:preformatting:selectors-profile buildSelectorProfile START +0ms\n\n  penthouse:preformatting:selectors-profile forceInclude body +1ms\n\n  penthouse:preformatting:selectors-profile buildSelectorProfile DONE +0ms\n\n  penthouse:core turn css to formatted selectorlist DONE +1ms\n\n  penthouse:core page load DONE +2s\n\n  penthouse:core waited for renderWaitTime: 100 +100ms\n\n  penthouse:core pruneNonCriticalSelectors init +4ms\n\n  penthouse:core filterSelectors START +0ms\n\n  penthouse:core filterSelectors DONE +0ms\n\n  penthouse:core pruneNonCriticalSelectors done +1ms\n\n  penthouse:core AST cleanup START +0ms\n\n  penthouse:css-cleanup start +0ms\n\n  penthouse:css-cleanup commentRemover +0ms\n\n  penthouse:css-cleanup ruleSelectorRemover +0ms\n\n  penthouse:css-cleanup:unused-keyframe-remover getAllAnimationKeyframes +0ms\n\n  penthouse:css-cleanup:unused-keyframe-remover getAllAnimationKeyframes AFTER, usedKeyFrames: 0 +3ms\n\n  penthouse:css-cleanup unusedKeyframeRemover +3ms\n\n  penthouse:css-cleanup:embeddedbase64Remover config: maxEmbeddedBase64Length = 1000 +0ms\n\n  penthouse:css-cleanup embeddedbase64Remover +1ms\n\n  penthouse:css-cleanup:unused-font-face-remover getAllFontNameValues +0ms\n\n  penthouse:css-cleanup:unused-font-face-remover getAllFontNameValues AFTER +0ms\n\n  penthouse:css-cleanup unusedFontFaceRemover +0ms\n\n  penthouse:css-cleanup propertiesToRemove +0ms\n\n  penthouse:css-cleanup finalRuleRemover +1ms\n\n  penthouse:core AST cleanup DONE +5ms\n\n  penthouse:core generated CSS from AST +0ms\n\n  penthouse:core generateCriticalCss DONE +0ms\n\n  penthouse:core cleanupAndExit +0ms\n\n  penthouse:browser remove (maybe) browser page for generateCriticalCss, before removing was: 1 +2s\n\n  penthouse:browser now try to close browser page +0ms\n\n  penthouse generateCriticalCss done +2s\n\n  penthouse:browser closed browser +18ms\n\nThe command \"env DEBUG=\"penthouse,penthouse:*\" node KiraPenthousePassed.js\" exited with 0.\n```\n\n**If** my iframe at the top of my real HTML page and loads when the page is opened, I don\u2019t get errors when using Penthouse.\n\n#### 3.2. Error \u2014 KiraPenthouseFailed.js\n\n[**Travis link**](https://app.travis-ci.com/github/Kristinita/SashaTravis/jobs/583027378#L253):\n\n```js\n$ env DEBUG=\"penthouse,penthouse:*\" node KiraPenthouseFailed.js\n\n  penthouse:browser no browser instance, launching new browser.. +0ms\n\n  penthouse:browser browser ready +103ms\n\n  penthouse call generateCriticalCssWrapped +0ms\n\n  penthouse:core Penthouse core start +0ms\n\n  penthouse:core parse ast START +1ms\n\n  penthouse:core parse ast DONE (with 0 errors) +2ms\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover BEFORE +0ms\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover matchConfig: {\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"type\": \"screen\",\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"width\": \"1300px\",\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"height\": \"900px\"\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover }\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover keepLargerMediaQueries: false +0ms\n\n  penthouse:core stripped out non matching media queries +3ms\n\n  penthouse:browser re-using the page browser launched with +91ms\n\n  penthouse:browser re-using browser page for generateCriticalCss, remaining at: 1 +1ms\n\n  penthouse:core open page ready in browser +79ms\n\n  penthouse:core page event listeners set +1ms\n\n  penthouse:core userAgent set +2ms\n\n  penthouse:core blocking js requests DONE +0ms\n\n  penthouse:core preparePage DONE +0ms\n\n  penthouse:core page load start +0ms\n\n  penthouse:core turn css to formatted selectorlist START +1ms\n\n  penthouse:preformatting:selectors-profile buildSelectorProfile START +0ms\n\n  penthouse:preformatting:selectors-profile forceInclude body +0ms\n\n  penthouse:preformatting:selectors-profile buildSelectorProfile DONE +0ms\n\n  penthouse:core turn css to formatted selectorlist DONE +1ms\n\n  penthouse:core cleanupAndExit +30s\n\n  penthouse:browser remove (maybe) browser page for generateCriticalCss, before removing was: 1 +30s\n\n  penthouse:browser now try to close browser page +0ms\n\n  penthouse:browser closed browser +18ms\n\n/home/travis/build/Kristinita/SashaTravis/node_modules/penthouse/lib/core.js:342\n\n\t\terror: new Error('Penthouse timed out after ' + timeout / 1000 + 's. ')\n\n\t\t\t   ^\n\nError: Penthouse timed out after 30s.\n\n\tat Timeout.<anonymous> (/home/travis/build/Kristinita/SashaTravis/node_modules/penthouse/lib/core.js:342:16)\n\n\tat listOnTimeout (node:internal/timers:564:17)\n\n\tat process.processTimers (node:internal/timers:507:7)\n\nNode.js v18.9.0\n\nThe command \"env DEBUG=\"penthouse,penthouse:*\" node KiraPenthouseFailed.js\" exited with 1.\n```\n\n**Else** my iframe is in the middle or end of my real HTML page and loads lazy, I get this stack trace when I use Penthouse.\n\n### 4. Environment\n\n1. Operating system:\n\n\t1. Local \u2014 Microsoft Windows [Version 10.0.19041.1415]\n\t1. Travis CI \u2014 Ubuntu 22.04 LTS Jammy Jellyfish\n\n1. Node.js v18.9.0\n1. Penthouse 2.3.3\n\nThanks.",
                "reactions": {
                    "url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "timeline_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/timeline",
                "performed_via_github_app": null,
                "state_reason": null
            },
            "comment": {
                "url": "https://api.github.com/repos/pocketjoso/penthouse/issues/comments/1257229353",
                "html_url": "https://github.com/pocketjoso/penthouse/issues/348#issuecomment-1257229353",
                "issue_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348",
                "id": 1257229353,
                "node_id": "IC_kwDOAThrcs5K78wp",
                "user": {
                    "login": "pocketjoso",
                    "id": 7192832,
                    "node_id": "MDQ6VXNlcjcxOTI4MzI=",
                    "avatar_url": "https://avatars.githubusercontent.com/u/7192832?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/pocketjoso",
                    "html_url": "https://github.com/pocketjoso",
                    "followers_url": "https://api.github.com/users/pocketjoso/followers",
                    "following_url": "https://api.github.com/users/pocketjoso/following{/other_user}",
                    "gists_url": "https://api.github.com/users/pocketjoso/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/pocketjoso/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/pocketjoso/subscriptions",
                    "organizations_url": "https://api.github.com/users/pocketjoso/orgs",
                    "repos_url": "https://api.github.com/users/pocketjoso/repos",
                    "events_url": "https://api.github.com/users/pocketjoso/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/pocketjoso/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "created_at": "2022-09-25T16:29:20Z",
                "updated_at": "2022-09-25T16:29:20Z",
                "author_association": "OWNER",
                "body": "Thanks a lot for the detail bug report, and the reproducible test case - I can reproduce the problem.\r\n\r\nI will do my best to find time to look into this, but I wouldn't count on myself finding a fix in the near term. My first hunch is that - as you linked to issue #257 - that this is a problem from puppeteer, the version that is currently used. So what I would do next is to try to upgrade the puppeteer version, and see if that fixes the problem.\r\n",
                "reactions": {
                    "url": "https://api.github.com/repos/pocketjoso/penthouse/issues/comments/1257229353/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "performed_via_github_app": null
            }
        },
        "public": true,
        "created_at": "2022-09-25T16:29:20Z"
    },
    {
        "id": "24208985562",
        "type": "IssueCommentEvent",
        "actor": {
            "id": 7192832,
            "login": "pocketjoso",
            "display_login": "pocketjoso",
            "gravatar_id": "",
            "url": "https://api.github.com/users/pocketjoso",
            "avatar_url": "https://avatars.githubusercontent.com/u/7192832?"
        },
        "repo": {
            "id": 20474738,
            "name": "pocketjoso/penthouse",
            "url": "https://api.github.com/repos/pocketjoso/penthouse"
        },
        "payload": {
            "action": "created",
            "issue": {
                "url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348",
                "repository_url": "https://api.github.com/repos/pocketjoso/penthouse",
                "labels_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/labels{/name}",
                "comments_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/comments",
                "events_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/events",
                "html_url": "https://github.com/pocketjoso/penthouse/issues/348",
                "id": 1375841548,
                "node_id": "I_kwDOAThrcs5SAa0M",
                "number": 348,
                "title": "bug(iframes): timed out if lazy loaded iframes",
                "user": {
                    "login": "Kristinita",
                    "id": 17247677,
                    "node_id": "MDQ6VXNlcjE3MjQ3Njc3",
                    "avatar_url": "https://avatars.githubusercontent.com/u/17247677?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/Kristinita",
                    "html_url": "https://github.com/Kristinita",
                    "followers_url": "https://api.github.com/users/Kristinita/followers",
                    "following_url": "https://api.github.com/users/Kristinita/following{/other_user}",
                    "gists_url": "https://api.github.com/users/Kristinita/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/Kristinita/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/Kristinita/subscriptions",
                    "organizations_url": "https://api.github.com/users/Kristinita/orgs",
                    "repos_url": "https://api.github.com/users/Kristinita/repos",
                    "events_url": "https://api.github.com/users/Kristinita/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/Kristinita/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "labels": [],
                "state": "open",
                "locked": false,
                "assignee": null,
                "assignees": [],
                "milestone": null,
                "comments": 0,
                "created_at": "2022-09-16T11:52:34Z",
                "updated_at": "2022-09-25T16:29:20Z",
                "closed_at": null,
                "author_association": "NONE",
                "active_lock_reason": null,
                "body": "**#257** \u2014 possibly related issue\n\n### 1. Summary\n\nIf I use [**native lazy loading for iframes**](https://addyosmani.com/blog/native-iframe-lazy-loading/) in my HTML files, Penthouse doesn\u2019t create critical CSS for these files. I get a stack trace:\n\n```js\n/home/travis/build/Kristinita/SashaTravis/node_modules/penthouse/lib/core.js:342\n\n\t\terror: new Error('Penthouse timed out after ' + timeout / 1000 + 's. ')\n\n\t\t\t   ^\n\nError: Penthouse timed out after 30s.\n\n\tat Timeout.<anonymous> (/home/travis/build/Kristinita/SashaTravis/node_modules/penthouse/lib/core.js:342:16)\n\n\tat listOnTimeout (node:internal/timers:564:17)\n\n\tat process.processTimers (node:internal/timers:507:7)\n```\n\n### 2. MCVE\n\n[**This configuration on GitHub**](https://github.com/Kristinita/SashaTravis/tree/KiraPenthouseIframes), [**Travis CI build for it**](https://app.travis-ci.com/github/Kristinita/SashaTravis/jobs/583027378).\n\n1. `package.json`:\n\n\t```json\n\t{\n\t\t\"dependencies\": {\n\t\t\t\"penthouse\": \"^2.3.3\"\n\t\t}\n\t}\n\n\t```\n\n1. `KiraExamplePassed.html`:\n\n\t```html\n\t<!DOCTYPE html>\n\t<html lang=\"ru\">\n\t\t<head>\n\t\t\t<meta charset=\"utf-8\">\n\t\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t\t\t<title>Penthouse + lazy-loaded iframes MCVE \u2014 passed</title>\n\t\t\t<!-- [INFO] In real files I have HTML markup before the iframe instead of \u201cmargin-bottom\u201d -->\n\t\t\t<style>\n\t\t\t\t.KiraExampleClass { margin-bottom: 1rem; }\n\t\t\t</style>\n\t\t\t<!-- [INFO] Iframes native lazy loading polyfill:\n\t\t\thttps://github.com/mfranzke/loading-attribute-polyfill -->\n\t\t\t<script src=\"https://cdn.jsdelivr.net/npm/loading-attribute-polyfill/dist/loading-attribute-polyfill.umd.min.js\" async></script>\n\t\t</head>\n\t\t<body>\n\t\t\t<div class=\"KiraExampleClass\"></div>\n\t\t\t<!-- [INFO] Iframes syntax:\n\t\t\thttps://github.com/mfranzke/loading-attribute-polyfill#iframe -->\n\t\t\t<noscript class=\"loading-lazy\">\n\t\t\t\t<iframe title=\"KiraExamplePeerTubeVideo\" width=\"560\" height=\"315\" src=\"https://video.ploud.fr/videos/embed/15613130-601b-4101-bc39-2dde03256254\" loading=\"lazy\"></iframe>\n\t\t\t</noscript>\n\t\t</body>\n\t</html>\n\n\t```\n\n1. `KiraExampleFailed.html`:\n\n\t```html\n\t<!DOCTYPE html>\n\t<html lang=\"ru\">\n\t\t<head>\n\t\t\t<meta charset=\"utf-8\">\n\t\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t\t\t<title>Penthouse + lazy-loaded iframes MCVE \u2014 passed</title>\n\t\t\t<!-- [INFO] In real files I have HTML markup before the iframe instead of \u201cmargin-bottom\u201d -->\n\t\t\t<style>\n\t\t\t\t\t.KiraExampleClass { margin-bottom: 500rem; }\n\t\t\t</style>\n\t\t\t<!-- [INFO] Iframes native lazy loading polyfill:\n\t\t\thttps://github.com/mfranzke/loading-attribute-polyfill -->\n\t\t\t<script src=\"https://cdn.jsdelivr.net/npm/loading-attribute-polyfill/dist/loading-attribute-polyfill.umd.min.js\" async></script>\n\t\t</head>\n\t\t<body>\n\t\t\t<div class=\"KiraExampleClass\"></div>\n\t\t\t<!-- [INFO] Iframes syntax:\n\t\t\thttps://github.com/mfranzke/loading-attribute-polyfill#iframe -->\n\t\t\t<noscript class=\"loading-lazy\">\n\t\t\t\t<iframe title=\"KiraExamplePeerTubeVideo\" width=\"560\" height=\"315\" src=\"https://video.ploud.fr/videos/embed/15613130-601b-4101-bc39-2dde03256254\" loading=\"lazy\"></iframe>\n\t\t\t</noscript>\n\t\t</body>\n\t</html>\n\n\t```\n\n\t```diff\n\t-\t.KiraExampleClass { margin-bottom: 1rem; }\n\t+\t.KiraExampleClass { margin-bottom: 500rem; }\n\t```\n\n\n1. `KiraPenthousePassed.js`:\n\n\t```js\n\tconst penthouse = require('penthouse');\n\tconst fs = require('fs');\n\n\tpenthouse({\n\t\t// [INFO] \u201curl: 'file:///D:/SashaDemoRepositories/SashaTravis/KiraExamplePassed.html',\u201d for my Windows\n\t\turl: 'file:///home/travis/build/Kristinita/SashaTravis/KiraExamplePassed.html',\n\t\tcssString: 'body { color: red }'\n\t})\n\t\t.then(criticalCss => {\n\t\t\tfs.writeFileSync('KiraOutfilePassed.css', criticalCss);\n\t\t});\n\n\t```\n\n1. `KiraPenthouseFailed.js`:\n\n\t```js\n\tconst penthouse = require('penthouse');\n\tconst fs = require('fs');\n\n\tpenthouse({\n\t\t// [INFO] \u201curl: 'file:///D:/SashaDemoRepositories/SashaTravis/KiraExampleFailed.html',\u201d for my Windows\n\t\turl: 'file:///home/travis/build/Kristinita/SashaTravis/KiraExampleFailed.html',\n\t\tcssString: 'body { color: red }'\n\t})\n\t\t.then(criticalCss => {\n\t\t\tfs.writeFileSync('KiraOutfileFailed.css', criticalCss);\n\t\t});\n\n\t```\n\n\t```diff\n\t-\t// [INFO] \u201curl: 'file:///D:/SashaDemoRepositories/SashaTravis/KiraExamplePassed.html',\u201d for my Windows\n\t-\turl: 'file:///home/travis/build/Kristinita/SashaTravis/KiraExamplePassed.html',\n\t+\t// [INFO] \u201curl: 'file:///D:/SashaDemoRepositories/SashaTravis/KiraExampleFailed.html',\u201d for my Windows\n\t+\turl: 'file:///home/travis/build/Kristinita/SashaTravis/KiraExampleFailed.html',\n\n\t-\tfs.writeFileSync('KiraOutfilePassed.css', criticalCss);\n\t+\tfs.writeFileSync('KiraOutfileFailed.css', criticalCss);\n\t```\n\n1. The part of the `.travis.yml`:\n\n\t```yaml\n\tinstall:\n\t- npm install\n\n\tscript:\n\t- env DEBUG=\"penthouse,penthouse:*\" node KiraPenthousePassed.js\n\t- env DEBUG=\"penthouse,penthouse:*\" node KiraPenthouseFailed.js\n\n\t```\n\n### 3. Behavior\n\n#### 3.1. Desired \u2014 KiraPenthousePassed.js\n\n[**Travis link**](https://app.travis-ci.com/github/Kristinita/SashaTravis/jobs/583027378#L196):\n\n```js\n$ env DEBUG=\"penthouse,penthouse:*\" node KiraPenthousePassed.js\n\n  penthouse:browser no browser instance, launching new browser.. +0ms\n\n  penthouse:browser browser ready +250ms\n\n  penthouse call generateCriticalCssWrapped +0ms\n\n  penthouse:core Penthouse core start +0ms\n\n  penthouse:core parse ast START +0ms\n\n  penthouse:core parse ast DONE (with 0 errors) +3ms\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover BEFORE +0ms\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover matchConfig: {\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"type\": \"screen\",\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"width\": \"1300px\",\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"height\": \"900px\"\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover }\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover keepLargerMediaQueries: false +0ms\n\n  penthouse:core stripped out non matching media queries +1ms\n\n  penthouse:browser re-using the page browser launched with +95ms\n\n  penthouse:browser re-using browser page for generateCriticalCss, remaining at: 1 +0ms\n\n  penthouse:core open page ready in browser +88ms\n\n  penthouse:core page event listeners set +1ms\n\n  penthouse:core userAgent set +1ms\n\n  penthouse:core blocking js requests DONE +1ms\n\n  penthouse:core preparePage DONE +0ms\n\n  penthouse:core page load start +0ms\n\n  penthouse:core turn css to formatted selectorlist START +1ms\n\n  penthouse:preformatting:selectors-profile buildSelectorProfile START +0ms\n\n  penthouse:preformatting:selectors-profile forceInclude body +1ms\n\n  penthouse:preformatting:selectors-profile buildSelectorProfile DONE +0ms\n\n  penthouse:core turn css to formatted selectorlist DONE +1ms\n\n  penthouse:core page load DONE +2s\n\n  penthouse:core waited for renderWaitTime: 100 +100ms\n\n  penthouse:core pruneNonCriticalSelectors init +4ms\n\n  penthouse:core filterSelectors START +0ms\n\n  penthouse:core filterSelectors DONE +0ms\n\n  penthouse:core pruneNonCriticalSelectors done +1ms\n\n  penthouse:core AST cleanup START +0ms\n\n  penthouse:css-cleanup start +0ms\n\n  penthouse:css-cleanup commentRemover +0ms\n\n  penthouse:css-cleanup ruleSelectorRemover +0ms\n\n  penthouse:css-cleanup:unused-keyframe-remover getAllAnimationKeyframes +0ms\n\n  penthouse:css-cleanup:unused-keyframe-remover getAllAnimationKeyframes AFTER, usedKeyFrames: 0 +3ms\n\n  penthouse:css-cleanup unusedKeyframeRemover +3ms\n\n  penthouse:css-cleanup:embeddedbase64Remover config: maxEmbeddedBase64Length = 1000 +0ms\n\n  penthouse:css-cleanup embeddedbase64Remover +1ms\n\n  penthouse:css-cleanup:unused-font-face-remover getAllFontNameValues +0ms\n\n  penthouse:css-cleanup:unused-font-face-remover getAllFontNameValues AFTER +0ms\n\n  penthouse:css-cleanup unusedFontFaceRemover +0ms\n\n  penthouse:css-cleanup propertiesToRemove +0ms\n\n  penthouse:css-cleanup finalRuleRemover +1ms\n\n  penthouse:core AST cleanup DONE +5ms\n\n  penthouse:core generated CSS from AST +0ms\n\n  penthouse:core generateCriticalCss DONE +0ms\n\n  penthouse:core cleanupAndExit +0ms\n\n  penthouse:browser remove (maybe) browser page for generateCriticalCss, before removing was: 1 +2s\n\n  penthouse:browser now try to close browser page +0ms\n\n  penthouse generateCriticalCss done +2s\n\n  penthouse:browser closed browser +18ms\n\nThe command \"env DEBUG=\"penthouse,penthouse:*\" node KiraPenthousePassed.js\" exited with 0.\n```\n\n**If** my iframe at the top of my real HTML page and loads when the page is opened, I don\u2019t get errors when using Penthouse.\n\n#### 3.2. Error \u2014 KiraPenthouseFailed.js\n\n[**Travis link**](https://app.travis-ci.com/github/Kristinita/SashaTravis/jobs/583027378#L253):\n\n```js\n$ env DEBUG=\"penthouse,penthouse:*\" node KiraPenthouseFailed.js\n\n  penthouse:browser no browser instance, launching new browser.. +0ms\n\n  penthouse:browser browser ready +103ms\n\n  penthouse call generateCriticalCssWrapped +0ms\n\n  penthouse:core Penthouse core start +0ms\n\n  penthouse:core parse ast START +1ms\n\n  penthouse:core parse ast DONE (with 0 errors) +2ms\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover BEFORE +0ms\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover matchConfig: {\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"type\": \"screen\",\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"width\": \"1300px\",\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover   \"height\": \"900px\"\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover }\n\n  penthouse:preformatting:nonMatchingMediaQueryRemover keepLargerMediaQueries: false +0ms\n\n  penthouse:core stripped out non matching media queries +3ms\n\n  penthouse:browser re-using the page browser launched with +91ms\n\n  penthouse:browser re-using browser page for generateCriticalCss, remaining at: 1 +1ms\n\n  penthouse:core open page ready in browser +79ms\n\n  penthouse:core page event listeners set +1ms\n\n  penthouse:core userAgent set +2ms\n\n  penthouse:core blocking js requests DONE +0ms\n\n  penthouse:core preparePage DONE +0ms\n\n  penthouse:core page load start +0ms\n\n  penthouse:core turn css to formatted selectorlist START +1ms\n\n  penthouse:preformatting:selectors-profile buildSelectorProfile START +0ms\n\n  penthouse:preformatting:selectors-profile forceInclude body +0ms\n\n  penthouse:preformatting:selectors-profile buildSelectorProfile DONE +0ms\n\n  penthouse:core turn css to formatted selectorlist DONE +1ms\n\n  penthouse:core cleanupAndExit +30s\n\n  penthouse:browser remove (maybe) browser page for generateCriticalCss, before removing was: 1 +30s\n\n  penthouse:browser now try to close browser page +0ms\n\n  penthouse:browser closed browser +18ms\n\n/home/travis/build/Kristinita/SashaTravis/node_modules/penthouse/lib/core.js:342\n\n\t\terror: new Error('Penthouse timed out after ' + timeout / 1000 + 's. ')\n\n\t\t\t   ^\n\nError: Penthouse timed out after 30s.\n\n\tat Timeout.<anonymous> (/home/travis/build/Kristinita/SashaTravis/node_modules/penthouse/lib/core.js:342:16)\n\n\tat listOnTimeout (node:internal/timers:564:17)\n\n\tat process.processTimers (node:internal/timers:507:7)\n\nNode.js v18.9.0\n\nThe command \"env DEBUG=\"penthouse,penthouse:*\" node KiraPenthouseFailed.js\" exited with 1.\n```\n\n**Else** my iframe is in the middle or end of my real HTML page and loads lazy, I get this stack trace when I use Penthouse.\n\n### 4. Environment\n\n1. Operating system:\n\n\t1. Local \u2014 Microsoft Windows [Version 10.0.19041.1415]\n\t1. Travis CI \u2014 Ubuntu 22.04 LTS Jammy Jellyfish\n\n1. Node.js v18.9.0\n1. Penthouse 2.3.3\n\nThanks.",
                "reactions": {
                    "url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "timeline_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348/timeline",
                "performed_via_github_app": null,
                "state_reason": null
            },
            "comment": {
                "url": "https://api.github.com/repos/pocketjoso/penthouse/issues/comments/1257229353",
                "html_url": "https://github.com/pocketjoso/penthouse/issues/348#issuecomment-1257229353",
                "issue_url": "https://api.github.com/repos/pocketjoso/penthouse/issues/348",
                "id": 1257229353,
                "node_id": "IC_kwDOAThrcs5K78wp",
                "user": {
                    "login": "pocketjoso",
                    "id": 7192832,
                    "node_id": "MDQ6VXNlcjcxOTI4MzI=",
                    "avatar_url": "https://avatars.githubusercontent.com/u/7192832?v=4",
                    "gravatar_id": "",
                    "url": "https://api.github.com/users/pocketjoso",
                    "html_url": "https://github.com/pocketjoso",
                    "followers_url": "https://api.github.com/users/pocketjoso/followers",
                    "following_url": "https://api.github.com/users/pocketjoso/following{/other_user}",
                    "gists_url": "https://api.github.com/users/pocketjoso/gists{/gist_id}",
                    "starred_url": "https://api.github.com/users/pocketjoso/starred{/owner}{/repo}",
                    "subscriptions_url": "https://api.github.com/users/pocketjoso/subscriptions",
                    "organizations_url": "https://api.github.com/users/pocketjoso/orgs",
                    "repos_url": "https://api.github.com/users/pocketjoso/repos",
                    "events_url": "https://api.github.com/users/pocketjoso/events{/privacy}",
                    "received_events_url": "https://api.github.com/users/pocketjoso/received_events",
                    "type": "User",
                    "site_admin": false
                },
                "created_at": "2022-09-25T16:29:20Z",
                "updated_at": "2022-09-25T16:29:20Z",
                "author_association": "OWNER",
                "body": "Thanks a lot for the detail bug report, and the reproducible test case - I can reproduce the problem.\r\n\r\nI will do my best to find time to look into this, but I wouldn't count on myself finding a fix in the near term. My first hunch is that - as you linked to issue #257 - that this is a problem from puppeteer, the version that is currently used. So what I would do next is to try to upgrade the puppeteer version, and see if that fixes the problem.\r\n",
                "reactions": {
                    "url": "https://api.github.com/repos/pocketjoso/penthouse/issues/comments/1257229353/reactions",
                    "total_count": 0,
                    "+1": 0,
                    "-1": 0,
                    "laugh": 0,
                    "hooray": 0,
                    "confused": 0,
                    "heart": 0,
                    "rocket": 0,
                    "eyes": 0
                },
                "performed_via_github_app": null
            }
        },
        "public": true,
        "created_at": "2022-09-25T16:29:20Z"
    }
]